#!/usr/bin/env python3
"""A script that combines exploitabilities of different runs into one file.

Usage:
    ./scripts/exploitability_combiner.py <starting-path>
"""
import json
import sys
from pathlib import Path
from typing import Any

import matplotlib.pyplot as plt  # type: ignore
import numpy as np

from incomplete_cooperative.run.save import Output
from scripts.find_data_jsons import find_data_jsons
from scripts.plot_base import NAME_MAP, filter_func, get_colors


def add_to_plt(data: np.ndarray, name: str, color: Any) -> Any:
    """Add data drawing to plot."""
    data_length = data.shape[0]
    mean = np.mean(data, 1)
    stde = np.std(data, 1)
    line = plt.plot(
        range(data_length), mean, color=color, zorder=4, label=name)[0]
    plt.fill_between(
        range(data_length), mean + stde, mean - stde, color=color, zorder=3, alpha=0.3)
    return line


def draw_combined_graph(exploitabilities: list[tuple[str, np.ndarray]], output_path: Path, title: str) -> None:
    """Draw data into a combined graph."""
    colors = get_colors(len(exploitabilities))
    plt.grid(zorder=-1, alpha=.3)
    plt.ylim(bottom=0, top=max(np.max(x) for _, x in exploitabilities))
    plt.xlim((0, exploitabilities[0][1].shape[0] - 1))
    lines = []
    for name, exploitability in exploitabilities:
        color = next(colors)
        print(name, np.mean(exploitability, 1))
        lines.append(add_to_plt(exploitability, NAME_MAP.get(name, name), color))
    plt.legend(handles=lines)
    plt.axvline(5, linestyle='--', alpha=.6, c="gray")  # TODO: implement later.
    plt.title(title, family="monospace")
    plt.xlabel("Steps")
    plt.ylabel("Exploitability")
    plt.savefig(output_path)
    plt.close('all')


def main(path: Path = Path(sys.argv[1]), title: str = sys.argv[2]) -> None:
    """Run the script."""
    for data in find_data_jsons(path):
        save_path = data.parent / "combined_exploitabilities.pdf"
        with data.open("r") as f:
            data_keys = json.load(f).keys()

        # a tuple (name, exploitabilities) of all runs (possibly filtered by the specified names in arg 3)
        exploitabilities = [(x, Output.from_file(data, x).data) for x in data_keys if filter_func(x)]
        draw_combined_graph(exploitabilities, save_path, title)


if __name__ == '__main__':
    main()
